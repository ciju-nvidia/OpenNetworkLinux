From 2d7c034f4f3740eded9df89f864dbdafa907a8d3 Mon Sep 17 00:00:00 2001
From: Vadim Pasternak <vadimp@nvidia.com>
Date: Thu, 23 Sep 2021 18:35:28 +0000
Subject: [PATCH backport v.4.19 1/1] TMP: Debug

---
 drivers/net/ethernet/mellanox/mlxsw/core_linecards.c |  2 ++
 drivers/net/ethernet/mellanox/mlxsw/minimal.c        | 10 +++++++---
 2 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/mellanox/mlxsw/core_linecards.c b/drivers/net/ethernet/mellanox/mlxsw/core_linecards.c
index 48d17b183fb7..cd14260fcddd 100644
--- a/drivers/net/ethernet/mellanox/mlxsw/core_linecards.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/core_linecards.c
@@ -160,6 +160,8 @@ static int __mlxsw_linecard_status_process(struct mlxsw_core *mlxsw_core,
 					&sr_valid, &ready, &active,
 					&hw_revision, &ini_version,
 					&card_type);
+	printk("%s delayed: %s, lc%u, prov %d, sr_valid %d, ready %d, active %d, hw_revision %u, ini_version %u provision_only %d\n",
+	       __func__, tmp_delayed ? "yes": "no", slot_index, provisioned, sr_valid, ready, active, hw_revision, ini_version, process_provision_only);
 
 	if (linecard) {
 		if (slot_index != linecard->slot_index)
diff --git a/drivers/net/ethernet/mellanox/mlxsw/minimal.c b/drivers/net/ethernet/mellanox/mlxsw/minimal.c
index 663798acee25..bab4961becc8 100644
--- a/drivers/net/ethernet/mellanox/mlxsw/minimal.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/minimal.c
@@ -164,6 +164,7 @@ mlxsw_m_port_create(struct mlxsw_m_area *mlxsw_m_area, u8 slot_index,
 	struct mlxsw_m *mlxsw_m = mlxsw_m_area->mlxsw_m;
 	struct mlxsw_m_port *mlxsw_m_port;
 	struct net_device *dev;
+	u8 port_to_area, off;
 	int err;
 
 	err = mlxsw_core_port_init(mlxsw_m->core, local_port, slot_index);
@@ -179,6 +180,9 @@ mlxsw_m_port_create(struct mlxsw_m_area *mlxsw_m_area, u8 slot_index,
 		goto err_alloc_etherdev;
 	}
 
+	/* Map local port to area index. */
+	off = mlxsw_m_area->module_off;
+	port_to_area = off ? local_port % off : local_port;
 	SET_NETDEV_DEV(dev, mlxsw_m->bus_info->dev);
 	mlxsw_m_port = netdev_priv(dev);
 	mlxsw_m_port->dev = dev;
@@ -186,7 +190,7 @@ mlxsw_m_port_create(struct mlxsw_m_area *mlxsw_m_area, u8 slot_index,
 	mlxsw_m_port->slot_index = slot_index;
 	mlxsw_m_port->local_port = local_port;
 	mlxsw_m_port->module = module;
-
+printk("%s slot_index %d local_port %d module %d port_to_area %d\n", __func__, slot_index, local_port, module, port_to_area);
 	dev->netdev_ops = &mlxsw_m_port_netdev_ops;
 	dev->ethtool_ops = &mlxsw_m_port_ethtool_ops;
 
@@ -199,7 +203,7 @@ mlxsw_m_port_create(struct mlxsw_m_area *mlxsw_m_area, u8 slot_index,
 
 	netif_carrier_off(dev);
 	mlxsw_m_port_switchdev_init(mlxsw_m_port);
-	mlxsw_m_area->ports[local_port] = mlxsw_m_port;
+	mlxsw_m_area->ports[port_to_area] = mlxsw_m_port;
 	err = register_netdev(dev);
 	if (err) {
 		dev_err(mlxsw_m->bus_info->dev, "Port %d: Failed to register netdev\n",
@@ -210,7 +214,7 @@ mlxsw_m_port_create(struct mlxsw_m_area *mlxsw_m_area, u8 slot_index,
 	return 0;
 
 err_register_netdev:
-	mlxsw_m_area->ports[local_port] = NULL;
+	mlxsw_m_area->ports[port_to_area] = NULL;
 	mlxsw_m_port_switchdev_fini(mlxsw_m_port);
 	free_netdev(dev);
 err_dev_addr_get:
-- 
2.20.1

