From 2023661f2daad2aa98d28437dcccd7c4752e1e53 Mon Sep 17 00:00:00 2001
From: Vadim Pasternak <vadimp@nvidia.com>
Date: Sun, 9 Jan 2022 21:34:59 +0200
Subject: [PATCH mlxsw/net-next 1/1] TMP: Debug

---
 drivers/net/ethernet/mellanox/mlxsw/minimal.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/mellanox/mlxsw/minimal.c b/drivers/net/ethernet/mellanox/mlxsw/minimal.c
index 2c54aef1e..e7a5a90b9 100644
--- a/drivers/net/ethernet/mellanox/mlxsw/minimal.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/minimal.c
@@ -246,7 +246,7 @@ mlxsw_m_port_create(struct mlxsw_m *mlxsw_m, u8 slot_index, u16 local_port,
 	module_offset = slot_index ? (slot_index - 1) *
 			mlxsw_m->max_module_count : 0;
 
-	err = mlxsw_core_port_init(mlxsw_m->core, local_port + module_offset, 0,
+	err = mlxsw_core_port_init(mlxsw_m->core, local_port /*+ module_offset*/, slot_index,
 				   module + 1 + module_offset, false, 0, false,
 				   0, mlxsw_m->base_mac,
 				   sizeof(mlxsw_m->base_mac));
@@ -362,6 +362,7 @@ static int mlxsw_m_ports_create(struct mlxsw_m *mlxsw_m, u8 slot_index)
 {
 	struct mlxsw_m_port_mapping *port_mapping;
 	char mgpir_pl[MLXSW_REG_MGPIR_LEN];
+	u8 module_offset;
 	int i, err;
 
 	mlxsw_reg_mgpir_pack(mgpir_pl, slot_index);
@@ -376,9 +377,15 @@ static int mlxsw_m_ports_create(struct mlxsw_m *mlxsw_m, u8 slot_index)
 		return 0;
 
 	mlxsw_m->line_cards[slot_index]->max_ports += 1;
+
+	module_offset = slot_index ? (slot_index - 1) *
+			mlxsw_m->max_module_count : 0;
+
+
 	/* Fill out module to local port mapping array */
 	for (i = 1; i < mlxsw_m->line_cards[slot_index]->max_ports; i++) {
-		err = mlxsw_m_port_module_map(mlxsw_m, slot_index, i, i - 1);
+		err = mlxsw_m_port_module_map(mlxsw_m, slot_index, i +
+					      module_offset, i - 1);
 		if (err)
 			goto err_module_to_port_map;
 	}
-- 
2.20.1

